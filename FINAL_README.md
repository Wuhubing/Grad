# 知识耦合分析系统 - 最终版本

## 🎯 项目概述

本项目是一个**GPU优化的多模型知识耦合分析系统**，专注于测量语言模型中知识片段间的耦合强度，并验证梯度相似性与涟漪效应的相关性。

## 🚀 核心特性

- **多模型支持**: GPT-2 和 LLaMA-2 系列模型
- **GPU加速**: 梯度计算和耦合矩阵计算完全在GPU上执行
- **详细结果**: 返回包含9个主要部分的完整分析结果
- **跨pot分析**: 自动分析不同HotpotQA问题间的知识耦合
- **可视化**: 自动生成耦合热图和分析报告

## 📁 核心文件

### 主要文件
- **`knowledge_coupling_mvp.py`** - 核心分析系统（779行）
- **`test_hotpot_20.json`** - 测试数据（20个HotpotQA样本）
- **`requirements.txt`** - 项目依赖

### 演示文件
- **`demo_results.py`** - 演示详细结果结构的脚本

### 输出文件
- **`coupling_heatmap.png`** - 耦合强度热图
- **`mvp_report.md`** - 分析报告
- **`complete_results_demo.json`** - 完整结果JSON

## 💻 使用方法

### 1. 基本运行
```bash
python knowledge_coupling_mvp.py \
  --hotpot_data test_hotpot_20.json \
  --model_path gpt2 \
  --max_samples 10 \
  --device cuda \
  --output_dir results
```

### 2. 查看详细结果
```bash
python demo_results.py
```

## 📊 Results 结构

运行分析后，`results` 字典包含以下9个主要部分：

### 1. **metadata** - 基本信息
```python
{
  'model_path': 'gpt2',
  'model_type': 'gpt2', 
  'device': 'cuda',
  'total_samples_processed': 10,
  'analysis_timestamp': '2025-06-06 09:24:43'
}
```

### 2. **knowledge_pieces** - 知识片段详情
```python
{
  'count': 10,
  'details': [详细的知识片段信息],
  'categories': {'Science': 7, 'Person': 3}
}
```

### 3. **gradient_analysis** - 梯度计算结果
```python
{
  'total_gradients_computed': 10,
  'target_layers_count': 12,
  'gradient_dimension': 28320768
}
```

### 4. **coupling_analysis** - 耦合强度分析
```python
{
  'total_pairs': 90,
  'high_coupling_pairs': 38,
  'mean_coupling': 0.4202,
  'max_coupling': 0.9995
}
```

### 5. **high_coupling_pairs** - 高耦合对详情
```python
{
  'count': 19,
  'threshold': 0.4,
  'top_10_detailed': [详细的候选对信息],
  'all_pairs': [所有高耦合对]
}
```

### 6. **cross_pot_analysis** - 跨pot分析
```python
{
  'unique_pots': 5,
  'cross_pot_pairs': 40,
  'same_pot_pairs': 5,
  'cross_pot_mean': 0.3811,
  'same_pot_mean': 0.7319
}
```

### 7. **generated_files** - 生成文件路径
```python
{
  'coupling_matrix': 'results/coupling_matrix.npy',
  'knowledge_pieces_json': 'results/knowledge_pieces.json',
  'heatmap_visualization': 'coupling_heatmap.png'
}
```

### 8. **gpu_performance** - GPU性能信息
```python
{
  'device': 'cuda',
  'gpu_name': 'NVIDIA A40',
  'gpu_memory_allocated_gb': 0.847,
  'gradient_computation': 'GPU'
}
```

### 9. **experiment_readiness** - 实验准备状态
```python
{
  'ripple_candidates_available': True,
  'recommended_candidates': 5,
  'next_steps': ['Run cross-pot coupling analysis', ...]
}
```

## 🔬 技术细节

### 核心算法
- **梯度计算**: `GradSim(i,j) = cos(∇_θ log P(a_i|q_i), ∇_θ log P(a_j|q_j))`
- **GPU优化**: 梯度计算加速从1.54s/it → 23.44it/s (15x提升)
- **目标层**: GPT-2的`transformer.h.{i}.mlp.c_proj`层

### 性能指标
- **GPU内存使用**: ~1.4GB (NVIDIA A40)
- **处理速度**: 23.44 样本/秒
- **梯度维度**: 28,320,768 参数

## 📈 典型分析结果

### 耦合强度统计
- **平均耦合**: 0.4202
- **高耦合对比例**: 42.22%
- **跨pot平均耦合**: 0.3811
- **同pot平均耦合**: 0.7319

### 实验发现
- 同一HotpotQA问题内的知识片段耦合明显高于跨问题耦合
- 高耦合对主要出现在相同类别的知识片段间
- GPU加速使大规模梯度分析成为可能

## 🎯 下一步研究方向

1. **涟漪效应验证**: 使用MEMIT编辑验证高耦合对的相互影响
2. **更大规模分析**: 扩展到更多样本和更大模型
3. **跨模型比较**: 比较不同模型架构的知识耦合模式
4. **因果关系研究**: 深入研究知识耦合的因果机制

## 📋 环境要求

- Python 3.8+
- PyTorch 2.0+
- CUDA GPU (推荐)
- 8GB+ GPU内存

## 🏆 项目成果

- ✅ GPU优化的知识耦合分析系统
- ✅ 详细的结果数据结构
- ✅ 跨pot耦合模式发现
- ✅ 可视化和报告生成
- ✅ 实验候选对自动识别

---

*Generated by Knowledge Coupling MVP System* 